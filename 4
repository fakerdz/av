getgenv().OldCFrame = nil
getgenv().Enabled = true

getgenv().Limits = {
    ["Blue"] = 1,
    ["Purple"] = 10
}

local SaveModule = require(game.ReplicatedStorage.Library.Client.Save)

local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

local PlayerCharacter = Workspace:WaitForChild(Players.LocalPlayer.Name)
local PlayerHumanoidRootPart =PlayerCharacter:FindFirstChild("HumanoidRootPart")

local PositionBlueChest = CFrame.new(-23.4127789, 3.60205817, 171.047852, -0.859449804, -2.70322804e-08, 0.511220098, 1.88000246e-08, 1, 8.44840713e-08, -0.511220098, 8.22207724e-08, -0.859449804)
local PositionSecretChest = CFrame.new(215.447311, -116.493744, -150.387924, 0.100747772, 2.0890738e-08, 0.994912028, 7.33217131e-09, 1, -2.17400515e-08, -0.994912028, 9.48512735e-09, 0.100747772)

-- PlayerCharacter:SetPrimaryPartCFrame(PositionBlueChest)


function OpenChest(amount, secret)
    local args = {
        [1] = amount,
        [2] = secret
    }

    game:GetService("ReplicatedStorage"):WaitForChild("Network"):WaitForChild("LootChest_Unlock"):InvokeServer(unpack(args))
end

function GetAmountOfSecretKeys()
    local PlayerSaves = SaveModule.GetSaves()[Players.LocalPlayer] or {}
    local ItemID = "4c56817ec1f14d04ac9b5d6183bb238b"
    local Item = PlayerSaves.Inventory.Misc[ItemID]

    if Item then
        return Item._am
    end

    return 0
end

function GetAmountOfCrystalKeys()
    local PlayerSaves = SaveModule.GetSaves()[Players.LocalPlayer] or {}
    local ItemID = "0a2b6f00bdcb42678b17c72b055753a3"
    local Item = PlayerSaves.Inventory.Misc[ItemID]

    if Item then
        return Item._am
    end

    return 0
end

function GetAmountOfOpensCrystalKeys()
    local Amount = GetAmountOfCrystalKeys()
    local StartingIndex = 10
    while StartingIndex > 0 do
        if Amount/StartingIndex >= 1 then
            return StartingIndex
        end
        StartingIndex = StartingIndex - 1
    end

    return 0
end

function SetCFrame()
    getgenv().OldCFrame = PlayerHumanoidRootPart.CFrame
end

spawn(function () 
    while wait() do
        
        if GetAmountOfSecretKeys() >= 1 and getgenv().Enabled and GetAmountOfSecretKeys() >= getgenv().Limits.Purple then
            SetCFrame()
            PlayerCharacter:SetPrimaryPartCFrame(PositionSecretChest)

            while GetAmountOfSecretKeys() >= 1 and getgenv().Enabled do
                OpenChest(1, true)
            end
            
            PlayerCharacter:SetPrimaryPartCFrame(getgenv().OldCFrame)
        end

        if GetAmountOfOpensCrystalKeys() >= 1 and getgenv().Enabled and GetAmountOfCrystalKeys() >= getgenv().Limits.Blue then
            SetCFrame()
            PlayerCharacter:SetPrimaryPartCFrame(PositionBlueChest)

            while GetAmountOfOpensCrystalKeys() >= 1 and getgenv().Enabled do
                local amount = GetAmountOfOpensCrystalKeys()
                OpenChest(amount, false)
            end

            PlayerCharacter:SetPrimaryPartCFrame(getgenv().OldCFrame)
        end

    end
end)
