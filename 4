print("Script đã khởi động")

-- Cấu hình chung
getgenv().OldCFrame = nil
getgenv().Enabled = true

getgenv().Limits = {
    ["Blue"] = 1,
    ["Purple"] = 10
}

-- Kiểm tra và tải SaveModule
local success, SaveModule = pcall(function() return require(game.ReplicatedStorage.Library.Client.Save) end)
if not success or not SaveModule then
    warn("SaveModule không tồn tại hoặc không thể tải.")
else
    print("SaveModule được tải thành công.")
end

local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

-- Kiểm tra LocalPlayer và Character
local Player = Players.LocalPlayer
if not Player then
    warn("LocalPlayer không tồn tại.")
else
    print("LocalPlayer:", Player.Name)
end

local PlayerCharacter = Workspace:FindFirstChild(Player.Name)
if not PlayerCharacter then
    warn("PlayerCharacter không tồn tại trong Workspace.")
else
    print("PlayerCharacter được tìm thấy:", PlayerCharacter.Name)
end

local PlayerHumanoidRootPart = PlayerCharacter and PlayerCharacter:FindFirstChild("HumanoidRootPart")
if not PlayerHumanoidRootPart then
    warn("HumanoidRootPart không tồn tại.")
else
    print("HumanoidRootPart được tìm thấy.")
end

local PositionBlueChest = CFrame.new(-23.4127789, 3.60205817, 171.047852)
local PositionSecretChest = CFrame.new(215.447311, -116.493744, -150.387924)

function OpenChest(amount, secret)
    print("Gọi OpenChest với số lượng:", amount, "và loại:", secret)
    local args = {
        [1] = amount,
        [2] = secret
    }

    local Network = game:GetService("ReplicatedStorage"):FindFirstChild("Network")
    if Network then
        print("Network tồn tại.")
        local LootChest_Unlock = Network:FindFirstChild("LootChest_Unlock")
        if LootChest_Unlock then
            print("LootChest_Unlock tồn tại. Mở hòm với số lượng:", amount, "và loại:", secret)
            LootChest_Unlock:InvokeServer(unpack(args))
        else
            warn("LootChest_Unlock không tồn tại trong Network.")
        end
    else
        warn("Network không tồn tại trong ReplicatedStorage.")
    end
end

function GetAmountOfSecretKeys()
    print("Gọi GetAmountOfSecretKeys")
    if not SaveModule or not SaveModule.GetSaves then
        warn("SaveModule hoặc hàm GetSaves() không tồn tại.")
        return 0
    end

    local PlayerSaves = SaveModule.GetSaves()[Players.LocalPlayer]
    if not PlayerSaves or not PlayerSaves.Inventory or not PlayerSaves.Inventory.Misc then
        warn("PlayerSaves, Inventory hoặc Misc không tồn tại.")
        return 0
    end

    local ItemID = "4c56817ec1f14d04ac9b5d6183bb238b"
    local Item = PlayerSaves.Inventory.Misc[ItemID]

    if Item then
        print("Số lượng Secret Keys:", Item._am)
        return Item._am
    else
        warn("Không tìm thấy Item với ID:", ItemID)
    end

    return 0
end

function GetAmountOfCrystalKeys()
    print("Gọi GetAmountOfCrystalKeys")
    if not SaveModule or not SaveModule.GetSaves then
        warn("SaveModule hoặc hàm GetSaves() không tồn tại.")
        return 0
    end

    local PlayerSaves = SaveModule.GetSaves()[Players.LocalPlayer]
    if not PlayerSaves or not PlayerSaves.Inventory or not PlayerSaves.Inventory.Misc then
        warn("PlayerSaves, Inventory hoặc Misc không tồn tại.")
        return 0
    end

    local ItemID = "0a2b6f00bdcb42678b17c72b055753a3"
    local Item = PlayerSaves.Inventory.Misc[ItemID]

    if Item then
        print("Số lượng Crystal Keys:", Item._am)
        return Item._am
    else
        warn("Không tìm thấy Item với ID:", ItemID)
    end

    return 0
end

function GetAmountOfOpensCrystalKeys()
    print("Gọi GetAmountOfOpensCrystalKeys")
    local Amount = GetAmountOfCrystalKeys()
    local StartingIndex = 10
    while StartingIndex > 0 do
        if Amount / StartingIndex >= 1 then
            print("Số lượng Opens Crystal Keys:", StartingIndex)
            return StartingIndex
        end
        StartingIndex = StartingIndex - 1
    end

    return 0
end

function SetCFrame()
    print("Thiết lập OldCFrame")
    if PlayerHumanoidRootPart then
        getgenv().OldCFrame = PlayerHumanoidRootPart.CFrame
    else
        warn("Không thể thiết lập OldCFrame vì HumanoidRootPart không tồn tại.")
    end
end

-- Vòng lặp kiểm tra chính
spawn(function()
    while wait(1) do
        print("Vòng lặp chính đang chạy...")

        local secretKeys = GetAmountOfSecretKeys()
        local crystalKeys = GetAmountOfCrystalKeys()

        print("Số lượng Secret Keys:", secretKeys)
        print("Số lượng Crystal Keys:", crystalKeys)

        if secretKeys >= 1 and getgenv().Enabled and secretKeys >= getgenv().Limits.Purple then
            print("Bắt đầu mở Secret Chest")
            SetCFrame()
            PlayerCharacter:SetPrimaryPartCFrame(PositionSecretChest)

            while GetAmountOfSecretKeys() >= 1 and getgenv().Enabled do
                OpenChest(1, true)
            end

            PlayerCharacter:SetPrimaryPartCFrame(getgenv().OldCFrame)
        end

        if GetAmountOfOpensCrystalKeys() >= 1 and getgenv().Enabled and crystalKeys >= getgenv().Limits.Blue then
            print("Bắt đầu mở Blue Chest")
            SetCFrame()
            PlayerCharacter:SetPrimaryPartCFrame(PositionBlueChest)

            while GetAmountOfOpensCrystalKeys() >= 1 and getgenv().Enabled do
                local amount = GetAmountOfOpensCrystalKeys()
                OpenChest(amount, false)
            end

            PlayerCharacter:SetPrimaryPartCFrame(getgenv().OldCFrame)
        end
    end
end)
