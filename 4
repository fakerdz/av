getgenv().OldCFrame = nil
getgenv().Enabled = true

getgenv().Limits = {
    ["Blue"] = 1,
    ["Purple"] = 10
}

local SaveModule = require(game.ReplicatedStorage.Library.Client.Save)

local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

-- Kiểm tra xem nhân vật người chơi đã tải chưa
local PlayerCharacter = Workspace:WaitForChild(Players.LocalPlayer.Name, 10)
if not PlayerCharacter then
    warn("Không thể tìm thấy nhân vật người chơi!")
    return
end

-- Kiểm tra xem HumanoidRootPart có tồn tại không
local PlayerHumanoidRootPart = PlayerCharacter:WaitForChild("HumanoidRootPart", 10)
if not PlayerHumanoidRootPart then
    warn("Không thể tìm thấy HumanoidRootPart!")
    return
end

-- Vị trí của các hòm (chỉnh lại nếu cần)
local PositionBlueChest = CFrame.new(-23.4127789, 3.60205817, 171.047852, -0.859449804, -2.70322804e-08, 0.511220098, 1.88000246e-08, 1, 8.44840713e-08, -0.511220098, 8.22207724e-08, -0.859449804)
local PositionSecretChest = CFrame.new(215.447311, -116.493744, -150.387924, 0.100747772, 2.0890738e-08, 0.994912028, 7.33217131e-09, 1, -2.17400515e-08, -0.994912028, 9.48512735e-09, 0.100747772)

-- Hàm mở hòm
function OpenChest(amount, secret)
    local args = {
        [1] = amount,
        [2] = secret
    }
    
    -- Kiểm tra và gọi InvokeServer
    local LootChestUnlock = game:GetService("ReplicatedStorage"):FindFirstChild("Network"):FindFirstChild("LootChest_Unlock")
    if LootChestUnlock then
        LootChestUnlock:InvokeServer(unpack(args))
    else
        warn("LootChest_Unlock không tồn tại.")
    end
end

-- Hàm lấy số lượng Secret Keys
function GetAmountOfSecretKeys()
    local PlayerSaves = SaveModule.GetSaves()[Players.LocalPlayer] or {}
    local ItemID = "4c56817ec1f14d04ac9b5d6183bb238b"
    local Item = PlayerSaves.Inventory.Misc[ItemID]

    if Item then
        return Item._am
    end

    return 0
end

-- Hàm lấy số lượng Crystal Keys
function GetAmountOfCrystalKeys()
    local PlayerSaves = SaveModule.GetSaves()[Players.LocalPlayer] or {}
    local ItemID = "0a2b6f00bdcb42678b17c72b055753a3"
    local Item = PlayerSaves.Inventory.Misc[ItemID]

    if Item then
        return Item._am
    end

    return 0
end

-- Hàm lấy số lượng lần mở hòm với Crystal Keys
function GetAmountOfOpensCrystalKeys()
    local Amount = GetAmountOfCrystalKeys()
    local StartingIndex = 10
    while StartingIndex > 0 do
        if Amount / StartingIndex >= 1 then
            return StartingIndex
        end
        StartingIndex = StartingIndex - 1
    end

    return 0
end

-- Hàm thiết lập vị trí ban đầu
function SetCFrame()
    getgenv().OldCFrame = PlayerHumanoidRootPart.CFrame
end

-- Chạy liên tục để mở hòm
spawn(function() 
    while wait() do
        if GetAmountOfSecretKeys() >= 1 and getgenv().Enabled and GetAmountOfSecretKeys() >= getgenv().Limits.Purple then
            SetCFrame()
            PlayerCharacter:SetPrimaryPartCFrame(PositionSecretChest)

            while GetAmountOfSecretKeys() >= 1 and getgenv().Enabled do
                OpenChest(1, true)
            end
            
            PlayerCharacter:SetPrimaryPartCFrame(getgenv().OldCFrame)
        end

        if GetAmountOfOpensCrystalKeys() >= 1 and getgenv().Enabled and GetAmountOfCrystalKeys() >= getgenv().Limits.Blue then
            SetCFrame()
            PlayerCharacter:SetPrimaryPartCFrame(PositionBlueChest)

            while GetAmountOfOpensCrystalKeys() >= 1 and getgenv().Enabled do
                local amount = GetAmountOfOpensCrystalKeys()
                OpenChest(amount, false)
            end

            PlayerCharacter:SetPrimaryPartCFrame(getgenv().OldCFrame)
        end
    end
end)
